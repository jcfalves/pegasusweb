ko.tokenfield={};var engine=[],tokens=[],checkAvailable=!0;ko.bindingHandlers.tokenField={init:function(n,t,i){function u(n){var t=Bloodhound.tokenizers.whitespace(n.value),i=Bloodhound.tokenizers.whitespace(n.label),r=Bloodhound.tokenizers.whitespace(n.cnpj);return t.concat(i).concat(r)}console.log("--INIT:"+n.id);var r=t()||{};if(ko.tokenfield[n.id]={},ko.tokenfield[n.id].handlerEnabled=!0,ko.tokenfield[n.id].bindings={},ko.tokenfield[n.id].bindings.Remote=i().tokenFieldRemote,ko.tokenfield[n.id].bindings.Method=i().tokenFieldMethod,ko.tokenfield[n.id].bindings.Datatype=i().tokenFieldDatatype,ko.tokenfield[n.id].bindings.Query=i().tokenFieldQuery,ko.tokenfield[n.id].bindings.KeyIndex=i().tokenFieldKeyIndex,ko.tokenfield[n.id].bindings.KeyDisplay=i().tokenFieldKeyDisplay,ko.tokenfield[n.id].bindings.Delimiter=i().tokenFieldDelimiter,ko.tokenfield[n.id].bindings.CreateTokensOnBlur=i().tokenFieldCreateTokensOnBlur,ko.tokenfield[n.id].bindings.ParentValue=i().ParentValue,ko.tokenfield[n.id].bindings.Parent=i().Parent,ko.tokenfield[n.id].bindings.Remote===undefined)throw"Tokenfield remote server required.";ko.tokenfield[n.id].bindings.Method===undefined&&(ko.tokenfield[n.id].bindings.Method="POST");ko.tokenfield[n.id].bindings.Datatype===undefined&&(ko.tokenfield[n.id].bindings.Datatype="json");ko.tokenfield[n.id].bindings.Query===undefined&&(ko.tokenfield[n.id].bindings.Query="search");ko.tokenfield[n.id].bindings.KeyIndex===undefined&&(ko.tokenfield[n.id].bindings.KeyIndex="value");ko.tokenfield[n.id].bindings.KeyDisplay===undefined&&(ko.tokenfield[n.id].bindings.KeyDisplay="label");ko.tokenfield[n.id].bindings.Delimiter===undefined&&(ko.tokenfield[n.id].bindings.Delimiter=",");ko.tokenfield[n.id].bindings.CreateTokensOnBlur===undefined&&(ko.tokenfield[n.id].bindings.CreateTokensOnBlur=!1);ko.tokenfield[n.id].bindings.ParentValue===undefined&&(ko.tokenfield[n.id].bindings.ParentValue="");ko.tokenfield[n.id].bindings.Parent===undefined&&(ko.tokenfield[n.id].bindings.Parent="");ko.utils.domNodeDisposal.addDisposeCallback(n,function(){console.log("Destroy tokenfield");$(n).tokenfield("destroy")});ko.utils.registerEventHandler(n,"tokenfield:createdtoken",function(t){console.log("tokenfield:createdtoken:"+this.id);console.log(JSON.stringify(t.attrs));t.attrs[ko.tokenfield[n.id].bindings.KeyDisplay].indexOf("_")===0&&(console.log("tt-private"),$(t.relatedTarget).addClass("tt-private"));ko.tokenfield[n.id].handlerEnabled===!0&&r.push(t.attrs)});ko.utils.registerEventHandler(n,"tokenfield:removedtoken",function(n){console.log("tokenfield:removedtoken:"+n.value);console.log(JSON.stringify(n.attrs));var i=r.peek(),t;ko.utils.arrayForEach(i,function(i){ko.unwrap(i.value)===n.attrs.value?t=i:ko.unwrap(i.label)===n.attrs.label&&ko.unwrap(i.value)===n.attrs.value&&(t=i)});r.remove(t)});$.ajax({url:ko.tokenfield[n.id].bindings.Remote,type:ko.tokenfield[n.id].bindings.Method,contentType:"application/json",dataType:ko.tokenfield[n.id].bindings.Datatype,success:function(t){tokens[n.id]=t},error:function(){response([])},complete:function(){engine[n.id]=new Bloodhound({local:tokens[n.id],identify:function(n){return n.value},datumTokenizer:function(n){return u(n)},queryTokenizer:Bloodhound.tokenizers.whitespace});$("#"+n.id).val("");engine[n.id].initialize();$(n).tokenfield({delimiter:ko.tokenfield[n.id].bindings.Delimiter,createTokensOnBlur:!0,allowEditing:!1,typeahead:[{minLength:3},{name:n.id,displayKey:ko.tokenfield[n.id].bindings.KeyDisplay,source:engine[n.id].ttAdapter()}]});$(n).on("tokenfield:createtoken",function(t){var r=tokens[n.id],i=!1;$.each(r,function(n,r){r.value==t.attrs.value&&(i=!0)});i===!1&&checkAvailable&&t.preventDefault()});$(n).parent().on("keyup",function(t){if(t.which==9){$(".tt-suggestion:first-child",$(this)).trigger("click");return}var i=$(this).find("#"+n.id+"-tokenfield").val(),r=ko.tokenfield[n.id].bindings.ParentValue;i.length<3||$.ajax({url:ko.tokenfield[n.id].bindings.Remote,type:ko.tokenfield[n.id].bindings.Method,contentType:"application/json",dataType:ko.tokenfield[n.id].bindings.Datatype,data:ko.toJSON({search:i,parents:r}),success:function(t){tokens[n.id]=t},error:function(){response([])},complete:function(){engine[n.id].clear();engine[n.id].local=tokens[n.id];var t=engine[n.id].initialize(!0);t.done(function(){if($(".tt-dataset-"+n.id).children().length==0){var t=jQuery.Event("keydown");t.which=40;$("#"+n.id+"-tokenfield").trigger(t)}})}})})}})},update:function(n,t,i){checkAvailable=!1;ko.unwrap(i());console.log("--UPDATE:"+n.id);var r=t()||{},u=ko.unwrap(r.peek());ko.tokenfield[n.id].handlerEnabled=!1;r().length>0?$(n).tokenfield("setTokens",ko.toJS(u)):$(n).tokenfield("setTokens",[]);checkAvailable=!0;ko.tokenfield[n.id].handlerEnabled=!0}};